<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>איזור מנויים - החבר'ה הטובים</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com/3.4.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      color: #1c1e21;
    }
    .nav-bar {
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 0.5rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: #2c5282;
      cursor: pointer;
    }
    .search-bar {
      flex: 1;
      max-width: 400px;
    }
    .search-input {
      width: 100%;
      padding: 0.625rem 1rem;
      border: 1px solid #ddd;
      border-radius: 50px;
      font-size: 0.95rem;
    }
    .nav-icons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .nav-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f2f5;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.25rem;
      color: #050505;
    }
    .nav-icon:hover {
      background: #e4e6e9;
    }
    .main-container {
      max-width: 1200px;
      margin: 1rem auto;
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 1rem;
      padding: 0 1rem;
    }
    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      .sidebar { display: none; }
    }
    .sidebar {
      position: sticky;
      top: 72px;
      height: fit-content;
    }
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 500;
      color: #050505;
    }
    .sidebar-item:hover {
      background: #e4e6e9;
    }
    .sidebar-item.active {
      background: #e7f3ff;
      color: #1877f2;
    }
    .sidebar-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }
    .card-header {
      padding: 1rem;
      border-bottom: 1px solid #e4e6e9;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .card-body {
      padding: 1rem;
    }
    .post-create {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2c5282, #1a365d);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
      cursor: pointer;
    }
    .avatar.large {
      width: 100px;
      height: 100px;
      font-size: 2.5rem;
    }
    .post-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: #f0f2f5;
      border-radius: 50px;
      cursor: pointer;
      color: #65676b;
    }
    .post-content-input {
      width: 100%;
      padding: 0.875rem;
      border: 1px solid #e4e6e9;
      border-radius: 8px;
      resize: vertical;
      min-height: 100px;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
    }
    .btn {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    .btn-primary {
      background: #2c5282;
      color: white;
    }
    .btn-primary:hover {
      background: #1a365d;
    }
    .btn-secondary {
      background: #e4e6e9;
      color: #050505;
    }
    .btn-secondary:hover {
      background: #d8dadf;
    }
    .btn-small {
      padding: 0.375rem 0.875rem;
      font-size: 0.875rem;
    }
    .post {
      border-bottom: 1px solid #e4e6e9;
      padding: 1rem;
    }
    .post:last-child {
      border-bottom: none;
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .post-author {
      flex: 1;
    }
    .post-author-name {
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .post-author-name:hover {
      text-decoration: underline;
    }
    .post-time {
      font-size: 0.8rem;
      color: #65676b;
    }
    .post-content {
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 0.75rem;
      white-space: pre-wrap;
    }
    .post-actions {
      display: flex;
      gap: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #e4e6e9;
    }
    .post-action {
      flex: 1;
      padding: 0.5rem;
      border: none;
      background: transparent;
      color: #65676b;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .post-action:hover {
      background: #f0f2f5;
    }
    .post-action.liked {
      color: #e74c3c;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #e4e6e9;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
    }
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f0f2f5;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      background: #e4e6e9;
    }
    .modal-body {
      padding: 1rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e4e6e9;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: 'Inter', sans-serif;
    }
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    .profile-header {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .cover-photo {
      height: 250px;
      background: linear-gradient(135deg, #2c5282, #1a365d);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3rem;
    }
    .profile-info {
      padding: 1rem;
      display: flex;
      align-items: flex-end;
      gap: 1rem;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2c5282, #1a365d);
      border: 4px solid white;
      margin-top: -60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 3rem;
    }
    .profile-details {
      flex: 1;
      padding-top: 0.5rem;
    }
    .profile-name {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .profile-bio {
      color: #65676b;
      margin-bottom: 0.5rem;
    }
    .profile-stats {
      display: flex;
      gap: 1.5rem;
      color: #65676b;
      font-size: 0.9rem;
    }
    .profile-tabs {
      display: flex;
      gap: 0.5rem;
      padding: 0 1rem;
      border-bottom: 1px solid #e4e6e9;
    }
    .profile-tab {
      padding: 1rem 1.5rem;
      border: none;
      background: transparent;
      color: #65676b;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .profile-tab:hover {
      background: #f0f2f5;
    }
    .profile-tab.active {
      color: #2c5282;
      border-bottom-color: #2c5282;
    }
    .friend-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-bottom: 1px solid #e4e6e9;
    }
    .friend-card:last-child {
      border-bottom: none;
    }
    .friend-info {
      flex: 1;
    }
    .friend-name {
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .friend-name:hover {
      text-decoration: underline;
    }
    .group-card {
      display: flex;
      gap: 0.75rem;
      padding: 1rem;
      border: 1px solid #e4e6e9;
      border-radius: 8px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .group-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .group-icon {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: linear-gradient(135deg, #2c5282, #1a365d);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .group-info {
      flex: 1;
    }
    .group-name {
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: 0.25rem;
    }
    .group-meta {
      font-size: 0.85rem;
      color: #65676b;
    }
    .comment-list {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e4e6e9;
    }
    .comment-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .comment-bubble {
      background: #f0f2f5;
      padding: 0.5rem 0.75rem;
      border-radius: 18px;
      flex: 1;
    }
    .comment-author {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }
    .comment-text {
      font-size: 0.9rem;
    }
    .comment-input-container {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .comment-input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: none;
      background: #f0f2f5;
      border-radius: 18px;
      font-size: 0.9rem;
    }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-admin {
      background: #fee;
      color: #c00;
    }
    .badge-moderator {
      background: #fef3cd;
      color: #856404;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #65676b;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const supabase = window.supabase.createClient(
      'https://hzixitruvlsagrzqjrbw.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6aXhpdHJ1dmxzYWdyenFqcmJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMzY4ODYsImV4cCI6MjA3NjcxMjg4Nn0.rwOdyWdWTuY55hs-ctOnD43Kz9drXusbDlfyMTyzrHI'
    );

    const MembersArea = () => {
      const [user, setUser] = React.useState(null);
      const [userProfile, setUserProfile] = React.useState(null);
      const [activeView, setActiveView] = React.useState('feed');
      const [selectedProfile, setSelectedProfile] = React.useState(null);
      const [selectedGroup, setSelectedGroup] = React.useState(null);

      // Data states
      const [posts, setPosts] = React.useState([]);
      const [users, setUsers] = React.useState([]);
      const [friends, setFriends] = React.useState([]);
      const [friendRequests, setFriendRequests] = React.useState([]);
      const [groups, setGroups] = React.useState([]);
      const [myGroups, setMyGroups] = React.useState([]);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [showSearchResults, setShowSearchResults] = React.useState(false);

      // Modal states
      const [showCreatePost, setShowCreatePost] = React.useState(false);
      const [showEditProfile, setShowEditProfile] = React.useState(false);
      const [showCreateGroup, setShowCreateGroup] = React.useState(false);
      const [newPost, setNewPost] = React.useState('');
      const [commentInputs, setCommentInputs] = React.useState({});
      const [postComments, setPostComments] = React.useState({});

      // AI & Stock states
      const [aiCharacters, setAiCharacters] = React.useState([]);
      const [selectedCharacter, setSelectedCharacter] = React.useState(null);
      const [aiPrompt, setAiPrompt] = React.useState('');
      const [userCredits, setUserCredits] = React.useState(2);
      const [bankBalance, setBankBalance] = React.useState(10.00);
      const [stockPrices, setStockPrices] = React.useState([]);
      const [userPortfolio, setUserPortfolio] = React.useState([]);
      const [selectedStock, setSelectedStock] = React.useState(null);
      const [stockAmount, setStockAmount] = React.useState('');
      const [stockPriceHistory, setStockPriceHistory] = React.useState({});
      const [showAdminPanel, setShowAdminPanel] = React.useState(false);
      const [adminPassword, setAdminPassword] = React.useState('');
      const [aiRequests, setAiRequests] = React.useState([]);
      const [stockIndices, setStockIndices] = React.useState([]);
      const [shortPositions, setShortPositions] = React.useState([]);
      const [tradeType, setTradeType] = React.useState('buy');

      React.useEffect(() => {
        const savedUser = localStorage.getItem('hevre_user');
        if (!savedUser) {
          window.location.href = 'main.html';
          return;
        }
        const userData = JSON.parse(savedUser);
        setUser(userData);
        loadUserProfile(userData.phone);
      }, []);

      React.useEffect(() => {
        if (user) {
          loadData();

          // Auto-refresh stock prices every 30 seconds
          const stockInterval = setInterval(() => {
            if (activeView === 'stocks') {
              loadStockPrices();
              loadUserPortfolio();
              loadShortPositions();
            }
          }, 30000); // 30 seconds

          // Trigger stock update every 30 seconds
          const updateInterval = setInterval(async () => {
            try {
              await fetch(`${supabase.supabaseUrl}/functions/v1/update-stock-prices`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${supabase.supabaseKey}`,
                }
              });
            } catch (err) {
              console.error('Failed to update stock prices:', err);
            }
          }, 30000);

          return () => {
            clearInterval(stockInterval);
            clearInterval(updateInterval);
          };
        }
      }, [user, activeView]);

      const loadData = () => {
        loadPosts();
        loadUsers();
        loadFriends();
        loadFriendRequests();
        loadGroups();
        loadMyGroups();
        loadAICharacters();
        loadUserCredits();
        loadBankAccount();
        loadStockPrices();
        loadUserPortfolio();
        loadStockIndices();
        loadShortPositions();
      };

      const loadUserProfile = async (phone) => {
        const { data } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('phone', phone)
          .maybeSingle();

        if (data) {
          setUserProfile(data);
        } else {
          const newProfile = {
            phone: phone,
            name: user?.name || phone,
            bio: null,
            location: null,
            work: null,
            education: null
          };
          await supabase.from('user_profiles').insert([newProfile]);
          setUserProfile(newProfile);
        }
      };

      const loadPosts = async () => {
        // Get friend phones
        const { data: friendships } = await supabase
          .from('friendships')
          .select('*')
          .or(`user1_phone.eq.${user.phone},user2_phone.eq.${user.phone}`);

        const friendPhones = friendships ? friendships.map(f =>
          f.user1_phone === user.phone ? f.user2_phone : f.user1_phone
        ) : [];

        // Add own phone to see own posts
        friendPhones.push(user.phone);

        // Load posts only from friends and self
        const { data } = await supabase
          .from('social_posts')
          .select('*')
          .in('author_phone', friendPhones)
          .order('created_at', { ascending: false });
        if (data) setPosts(data);
      };

      const loadUsers = async () => {
        const { data: profiles } = await supabase
          .from('user_profiles')
          .select('*');
        if (profiles) setUsers(profiles.filter(u => u.phone !== user.phone));
      };

      const loadFriends = async () => {
        const { data } = await supabase
          .from('friendships')
          .select('*')
          .or(`user1_phone.eq.${user.phone},user2_phone.eq.${user.phone}`);
        if (data) setFriends(data);
      };

      const loadFriendRequests = async () => {
        const { data } = await supabase
          .from('friend_requests')
          .select('*')
          .or(`requester_phone.eq.${user.phone},recipient_phone.eq.${user.phone}`)
          .eq('status', 'pending');
        if (data) setFriendRequests(data);
      };

      const loadGroups = async () => {
        const { data } = await supabase
          .from('groups')
          .select('*, group_members(count)')
          .order('created_at', { ascending: false });
        if (data) setGroups(data);
      };

      const loadMyGroups = async () => {
        const { data } = await supabase
          .from('group_members')
          .select('*, groups(*)')
          .eq('user_phone', user.phone);
        if (data) setMyGroups(data);
      };

      const createPost = async () => {
        if (!newPost.trim()) return;
        await supabase.from('social_posts').insert([{
          author_phone: user.phone,
          author_name: userProfile?.name || user.name,
          content: newPost
        }]);
        setNewPost('');
        setShowCreatePost(false);
        loadPosts();
      };

      const toggleLike = async (post) => {
        const likes = post.likes || [];
        const hasLiked = likes.includes(user.phone);
        const newLikes = hasLiked
          ? likes.filter(p => p !== user.phone)
          : [...likes, user.phone];

        await supabase
          .from('social_posts')
          .update({ likes: newLikes })
          .eq('id', post.id);
        loadPosts();
      };

      const addComment = async (postId) => {
        const content = commentInputs[postId];
        if (!content?.trim()) return;

        await supabase.from('post_comments').insert([{
          post_id: postId,
          author_phone: user.phone,
          author_name: userProfile?.name || user.name,
          content
        }]);

        setCommentInputs({ ...commentInputs, [postId]: '' });
        loadComments(postId);
      };

      const loadComments = async (postId) => {
        const { data } = await supabase
          .from('post_comments')
          .select('*')
          .eq('post_id', postId)
          .order('created_at', { ascending: true });

        if (data) {
          setPostComments({ ...postComments, [postId]: data });
        }
      };

      const sendFriendRequest = async (recipientPhone) => {
        try {
          // Check if request already exists
          const { data: existing } = await supabase
            .from('friend_requests')
            .select('*')
            .or(`requester_phone.eq.${user.phone},recipient_phone.eq.${user.phone}`)
            .or(`requester_phone.eq.${recipientPhone},recipient_phone.eq.${recipientPhone}`)
            .maybeSingle();

          if (existing) {
            alert('בקשת חברות כבר נשלחה');
            return;
          }

          await supabase.from('friend_requests').insert([{
            requester_phone: user.phone,
            recipient_phone: recipientPhone,
            status: 'pending'
          }]);

          loadFriendRequests();
          alert('בקשת החברות נשלחה בהצלחה!');
        } catch (err) {
          alert('שגיאה בשליחת בקשת חברות: ' + err.message);
        }
      };

      const acceptFriendRequest = async (request) => {
        try {
          const [phone1, phone2] = [request.requester_phone, request.recipient_phone].sort();

          await supabase.from('friendships').insert([{
            user1_phone: phone1,
            user2_phone: phone2
          }]);

          await supabase
            .from('friend_requests')
            .update({ status: 'accepted' })
            .eq('id', request.id);

          loadFriends();
          loadFriendRequests();
          loadPosts();
          alert('בקשת חברות אושרה!');
        } catch (err) {
          alert('שגיאה באישור בקשת חברות: ' + err.message);
        }
      };

      const updateProfile = async (updates) => {
        await supabase
          .from('user_profiles')
          .update(updates)
          .eq('phone', user.phone);
        loadUserProfile(user.phone);
        setShowEditProfile(false);
      };

      const createGroup = async (groupData) => {
        const { data: newGroup } = await supabase
          .from('groups')
          .insert([{ ...groupData, creator_phone: user.phone }])
          .select()
          .single();

        if (newGroup) {
          await supabase.from('group_members').insert([{
            group_id: newGroup.id,
            user_phone: user.phone,
            role: 'admin'
          }]);
          setShowCreateGroup(false);
          loadGroups();
          loadMyGroups();
        }
      };

      const joinGroup = async (groupId) => {
        const group = groups.find(g => g.id === groupId);
        if (group.privacy === 'private') {
          await supabase.from('group_join_requests').insert([{
            group_id: groupId,
            user_phone: user.phone,
            user_name: userProfile?.name || user.name
          }]);
        } else {
          await supabase.from('group_members').insert([{
            group_id: groupId,
            user_phone: user.phone,
            role: 'member'
          }]);
        }
        loadGroups();
        loadMyGroups();
      };

      const isFriend = (phone) => {
        return friends.some(f => f.user1_phone === phone || f.user2_phone === phone);
      };

      const hasPendingRequest = (phone) => {
        return friendRequests.some(r =>
          (r.requester_phone === user.phone && r.recipient_phone === phone) ||
          (r.requester_phone === phone && r.recipient_phone === user.phone)
        );
      };

      const isGroupMember = (groupId) => {
        return myGroups.some(m => m.group_id === groupId);
      };

      const getInitials = (name) => {
        return name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '?';
      };

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (minutes < 1) return 'עכשיו';
        if (minutes < 60) return `לפני ${minutes} דקות`;
        if (hours < 24) return `לפני ${hours} שעות`;
        return `לפני ${days} ימים`;
      };

      const handleLogout = () => {
        localStorage.removeItem('hevre_user');
        window.location.href = 'main.html';
      };

      const filteredUsers = users.filter(u =>
        u.name?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const handleSearch = (e) => {
        if (e.key === 'Enter' && searchTerm.trim()) {
          setActiveView('search');
          setShowSearchResults(true);
          setSelectedProfile(null);
          setSelectedGroup(null);
        }
      };

      // AI & Stock Functions
      const loadAICharacters = async () => {
        const { data } = await supabase.from('ai_characters').select('*').order('name');
        if (data) setAiCharacters(data);
      };

      const loadUserCredits = async () => {
        let { data } = await supabase.from('user_credits').select('*').eq('user_phone', user.phone).maybeSingle();
        if (!data) {
          await supabase.from('user_credits').insert([{ user_phone: user.phone, credits: 2 }]);
          data = { credits: 2 };
        }
        setUserCredits(data.credits);
      };

      const loadBankAccount = async () => {
        let { data } = await supabase.from('user_bank_accounts').select('*').eq('user_phone', user.phone).maybeSingle();
        if (!data) {
          await supabase.from('user_bank_accounts').insert([{ user_phone: user.phone, balance: 10.00 }]);
          data = { balance: 10.00 };
        }
        setBankBalance(parseFloat(data.balance));
      };

      const loadStockPrices = async () => {
        const { data } = await supabase.from('stock_prices').select('*').order('current_price', { ascending: false });
        if (data) setStockPrices(data);
      };

      const loadUserPortfolio = async () => {
        const { data } = await supabase.from('user_stock_portfolios').select('*').eq('user_phone', user.phone);
        if (data) setUserPortfolio(data);
      };

      const loadStockHistory = async (memberName) => {
        const { data } = await supabase
          .from('stock_price_history')
          .select('*')
          .eq('member_name', memberName)
          .order('timestamp', { ascending: true })
          .limit(50);
        if (data) {
          setStockPriceHistory({ ...stockPriceHistory, [memberName]: data });
        }
      };

      const loadStockIndices = async () => {
        const { data } = await supabase.from('stock_indices').select('*');
        if (data) setStockIndices(data);
      };

      const loadShortPositions = async () => {
        const { data } = await supabase.from('user_short_positions').select('*').eq('user_phone', user.phone);
        if (data) setShortPositions(data);
      };

      const handleGenerateAI = async () => {
        if (!selectedCharacter) {
          alert('אנא בחר דמות');
          return;
        }
        if (!aiPrompt.trim()) {
          alert('אנא כתוב פרומפט');
          return;
        }
        if (userCredits < 1) {
          alert('אין לך מספיק קרדיטים');
          return;
        }

        if (selectedCharacter.special_action === 'blacklist') {
          alert('הפרטים שלך נשלחו לדביר ברקת, נכנסת לרשימה השחורה. בהתחייבות');
        }

        try {
          await supabase.from('ai_requests').insert([{
            user_phone: user.phone,
            character_name: selectedCharacter.name,
            prompt: aiPrompt,
            status: 'pending'
          }]);

          await supabase.from('user_credits').update({ credits: userCredits - 1 }).eq('user_phone', user.phone);

          setUserCredits(userCredits - 1);
          setAiPrompt('');
          setSelectedCharacter(null);
          alert('ההקלטה תגיע בוואטסאפ בקרוב');
        } catch (err) {
          alert('שגיאה ביצירת בקשה: ' + err.message);
        }
      };

      const loadAIRequests = async () => {
        const { data } = await supabase.from('ai_requests').select('*').order('created_at', { ascending: false });
        if (data) setAiRequests(data);
      };

      const handleAdminLogin = () => {
        if (adminPassword === '316439249') {
          setShowAdminPanel(true);
          loadAIRequests();
        } else {
          alert('סיסמה שגויה');
        }
      };

      const buyStock = async () => {
        if (!selectedStock || !stockAmount || stockAmount <= 0) {
          alert('אנא בחר מניה וכמות');
          return;
        }

        const stock = stockPrices.find(s => s.member_name === selectedStock);
        const totalCost = stock.current_price * parseFloat(stockAmount);

        if (totalCost > bankBalance) {
          alert('אין לך מספיק כסף');
          return;
        }

        try {
          await supabase.from('stock_transactions').insert([{
            user_phone: user.phone,
            member_name: selectedStock,
            transaction_type: 'buy',
            shares: parseFloat(stockAmount),
            price_per_share: stock.current_price,
            total_amount: totalCost
          }]);

          const existingPosition = userPortfolio.find(p => p.member_name === selectedStock);
          if (existingPosition) {
            const newShares = parseFloat(existingPosition.shares) + parseFloat(stockAmount);
            const newAvgPrice = ((existingPosition.shares * existingPosition.average_buy_price) + totalCost) / newShares;
            await supabase.from('user_stock_portfolios')
              .update({ shares: newShares, average_buy_price: newAvgPrice, updated_at: new Date().toISOString() })
              .eq('id', existingPosition.id);
          } else {
            await supabase.from('user_stock_portfolios').insert([{
              user_phone: user.phone,
              member_name: selectedStock,
              shares: parseFloat(stockAmount),
              average_buy_price: stock.current_price
            }]);
          }

          await supabase.from('user_bank_accounts')
            .update({ balance: bankBalance - totalCost, updated_at: new Date().toISOString() })
            .eq('user_phone', user.phone);

          setBankBalance(bankBalance - totalCost);
          loadUserPortfolio();
          setStockAmount('');
          setSelectedStock(null);
          alert('רכישה בוצעה בהצלחה!');
        } catch (err) {
          alert('שגיאה ברכישה: ' + err.message);
        }
      };

      const sellStock = async () => {
        if (!selectedStock || !stockAmount || stockAmount <= 0) {
          alert('אנא בחר מניה וכמות');
          return;
        }

        const position = userPortfolio.find(p => p.member_name === selectedStock);
        if (!position || position.shares < parseFloat(stockAmount)) {
          alert('אין לך מספיק מניות');
          return;
        }

        const stock = stockPrices.find(s => s.member_name === selectedStock);
        const totalRevenue = stock.current_price * parseFloat(stockAmount);

        try {
          await supabase.from('stock_transactions').insert([{
            user_phone: user.phone,
            member_name: selectedStock,
            transaction_type: 'sell',
            shares: parseFloat(stockAmount),
            price_per_share: stock.current_price,
            total_amount: totalRevenue
          }]);

          const newShares = parseFloat(position.shares) - parseFloat(stockAmount);
          if (newShares > 0) {
            await supabase.from('user_stock_portfolios')
              .update({ shares: newShares, updated_at: new Date().toISOString() })
              .eq('id', position.id);
          } else {
            await supabase.from('user_stock_portfolios').delete().eq('id', position.id);
          }

          await supabase.from('user_bank_accounts')
            .update({ balance: bankBalance + totalRevenue, updated_at: new Date().toISOString() })
            .eq('user_phone', user.phone);

          setBankBalance(bankBalance + totalRevenue);
          loadUserPortfolio();
          setStockAmount('');
          setSelectedStock(null);
          alert('מכירה בוצעה בהצלחה!');
        } catch (err) {
          alert('שגיאה במכירה: ' + err.message);
        }
      };

      const shortStock = async () => {
        if (!selectedStock || !stockAmount || stockAmount <= 0) {
          alert('אנא בחר מניה וכמות');
          return;
        }

        const stock = stockPrices.find(s => s.member_name === selectedStock);
        const collateral = stock.current_price * parseFloat(stockAmount);

        if (collateral > bankBalance) {
          alert('אין לך מספיק כסף לביטחון');
          return;
        }

        try {
          await supabase.from('user_short_positions').insert([{
            user_phone: user.phone,
            member_name: selectedStock,
            shares: parseFloat(stockAmount),
            short_price: stock.current_price
          }]);

          await supabase.from('user_bank_accounts')
            .update({ balance: bankBalance - collateral, updated_at: new Date().toISOString() })
            .eq('user_phone', user.phone);

          setBankBalance(bankBalance - collateral);
          loadShortPositions();
          setStockAmount('');
          setSelectedStock(null);
          alert('שורט בוצע בהצלחה!');
        } catch (err) {
          alert('שגיאה בשורט: ' + err.message);
        }
      };

      const closeShort = async (shortPos) => {
        const stock = stockPrices.find(s => s.member_name === shortPos.member_name);
        const profit = (shortPos.short_price - stock.current_price) * shortPos.shares;
        const collateral = shortPos.short_price * shortPos.shares;
        const totalReturn = collateral + profit;

        try {
          await supabase.from('user_short_positions').delete().eq('id', shortPos.id);

          await supabase.from('user_bank_accounts')
            .update({ balance: bankBalance + totalReturn, updated_at: new Date().toISOString() })
            .eq('user_phone', user.phone);

          setBankBalance(bankBalance + totalReturn);
          loadShortPositions();
          alert(`שורט נסגר! ${profit >= 0 ? 'רווח' : 'הפסד'}: $${Math.abs(profit).toFixed(2)}`);
        } catch (err) {
          alert('שגיאה בסגירת שורט: ' + err.message);
        }
      };

      if (!user || !userProfile) return <div>טוען...</div>;

      return (
        <div>
          <div className="nav-bar">
            <div className="nav-content">
              <img
                src="https://i.ibb.co/wNDsz0FB/output-onlinepngtools.png"
                alt="החבר'ה הטובים"
                style={{height: '40px', cursor: 'pointer'}}
                onClick={() => { setActiveView('feed'); setSelectedProfile(null); setSelectedGroup(null); }}
              />
              <div className="search-bar">
                <input
                  type="text"
                  className="search-input"
                  placeholder="חפש חברים... (לחץ Enter לחיפוש)"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  onKeyPress={handleSearch}
                />
              </div>
              <div className="nav-icons">
                <div className="nav-icon" onClick={() => { setActiveView('feed'); setSelectedProfile(null); setSelectedGroup(null); }} title="בית">
                  <i className="fas fa-home"></i>
                </div>
                <div className="nav-icon" onClick={() => { setActiveView('friends'); setSelectedProfile(null); setSelectedGroup(null); }} title="חברים">
                  <i className="fas fa-user-friends"></i>
                </div>
                <div className="nav-icon" onClick={() => { setActiveView('groups'); setSelectedProfile(null); setSelectedGroup(null); }} title="קבוצות">
                  <i className="fas fa-users"></i>
                </div>
                <div className="nav-icon" onClick={() => { setActiveView('hevre-ai'); setSelectedProfile(null); setSelectedGroup(null); }} title="החבר'ה AI">
                  <i className="fas fa-robot"></i>
                </div>
                <div className="nav-icon" onClick={() => { setActiveView('stocks'); setSelectedProfile(null); setSelectedGroup(null); }} title="שוק ההון">
                  <i className="fas fa-chart-line"></i>
                </div>
                <div className="nav-icon" onClick={() => setSelectedProfile(userProfile)} title="פרופיל">
                  <div className="avatar" style={{width: '36px', height: '36px', fontSize: '0.9rem'}}>
                    {getInitials(userProfile.name)}
                  </div>
                </div>
                <a href="main.html" className="btn btn-secondary btn-small" style={{textDecoration: 'none'}}>
                  חזור לאתר
                </a>
                <button onClick={handleLogout} className="btn btn-secondary btn-small">
                  התנתק
                </button>
              </div>
            </div>
          </div>

          <div className="main-container">
            <div className="sidebar">
              <div className="sidebar-item" onClick={() => setSelectedProfile(userProfile)}>
                <div className="avatar" style={{width: '36px', height: '36px', fontSize: '0.9rem'}}>
                  {getInitials(userProfile.name)}
                </div>
                <span>{userProfile.name}</span>
              </div>
              <div className="sidebar-item" onClick={() => { setActiveView('friends'); setSelectedProfile(null); setSelectedGroup(null); }}>
                <div className="sidebar-icon" style={{background: '#e7f3ff', color: '#1877f2'}}>
                  <i className="fas fa-user-friends"></i>
                </div>
                <span>חברים</span>
              </div>
              <div className="sidebar-item" onClick={() => { setActiveView('groups'); setSelectedProfile(null); setSelectedGroup(null); }}>
                <div className="sidebar-icon" style={{background: '#e7f3ff', color: '#1877f2'}}>
                  <i className="fas fa-users"></i>
                </div>
                <span>קבוצות</span>
              </div>
              <div className="sidebar-item" onClick={() => { setActiveView('hevre-ai'); setSelectedProfile(null); setSelectedGroup(null); }}>
                <div className="sidebar-icon" style={{background: '#f0f9ff', color: '#3b82f6'}}>
                  <i className="fas fa-robot"></i>
                </div>
                <span>החבר'ה AI</span>
              </div>
              <div className="sidebar-item" onClick={() => { setActiveView('stocks'); setSelectedProfile(null); setSelectedGroup(null); }}>
                <div className="sidebar-icon" style={{background: '#d1fae5', color: '#059669'}}>
                  <i className="fas fa-chart-line"></i>
                </div>
                <span>שוק ההון</span>
              </div>
            </div>

            <div>
              {activeView === 'feed' && !selectedProfile && !selectedGroup && (
                <>
                  <div className="card">
                    <div className="card-body">
                      <div className="post-create">
                        <div className="avatar">{getInitials(userProfile.name)}</div>
                        <div
                          className="post-input"
                          onClick={() => setShowCreatePost(true)}
                        >
                          מה עובר עליך, {userProfile.name.split(' ')[0]}?
                        </div>
                      </div>
                    </div>
                  </div>

                  {posts.length === 0 && (
                    <div className="card">
                      <div className="card-body">
                        <div className="empty-state">
                          <i className="fas fa-newspaper"></i>
                          <div>אין פוסטים להצגה</div>
                          <div style={{fontSize: '0.9rem', marginTop: '0.5rem'}}>
                            הוסף חברים כדי לראות את הפוסטים שלהם
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {posts.map(post => (
                    <div key={post.id} className="card">
                      <div className="post">
                        <div className="post-header">
                          <div
                            className="avatar"
                            onClick={() => {
                              const author = users.find(u => u.phone === post.author_phone) || userProfile;
                              setSelectedProfile(author);
                            }}
                          >
                            {getInitials(post.author_name)}
                          </div>
                          <div className="post-author">
                            <div
                              className="post-author-name"
                              onClick={() => {
                                const author = users.find(u => u.phone === post.author_phone) || userProfile;
                                setSelectedProfile(author);
                              }}
                            >
                              {post.author_name}
                            </div>
                            <div className="post-time">{formatTime(post.created_at)}</div>
                          </div>
                        </div>
                        <div className="post-content">{post.content}</div>
                        <div className="post-actions">
                          <button
                            className={`post-action ${(post.likes || []).includes(user.phone) ? 'liked' : ''}`}
                            onClick={() => toggleLike(post)}
                          >
                            <i className="fas fa-heart"></i>
                            {(post.likes || []).length > 0 && (post.likes || []).length}
                          </button>
                          <button
                            className="post-action"
                            onClick={() => {
                              if (!postComments[post.id]) {
                                loadComments(post.id);
                              }
                            }}
                          >
                            <i className="fas fa-comment"></i>
                            תגובה
                          </button>
                        </div>

                        {postComments[post.id] && (
                          <div className="comment-list">
                            {postComments[post.id].map(comment => (
                              <div key={comment.id} className="comment-item">
                                <div className="avatar" style={{width: '32px', height: '32px', fontSize: '0.8rem'}}>
                                  {getInitials(comment.author_name)}
                                </div>
                                <div className="comment-bubble">
                                  <div className="comment-author">{comment.author_name}</div>
                                  <div className="comment-text">{comment.content}</div>
                                </div>
                              </div>
                            ))}
                            <div className="comment-input-container">
                              <div className="avatar" style={{width: '32px', height: '32px', fontSize: '0.8rem'}}>
                                {getInitials(userProfile.name)}
                              </div>
                              <input
                                type="text"
                                className="comment-input"
                                placeholder="כתוב תגובה..."
                                value={commentInputs[post.id] || ''}
                                onChange={(e) => setCommentInputs({ ...commentInputs, [post.id]: e.target.value })}
                                onKeyPress={(e) => e.key === 'Enter' && addComment(post.id)}
                              />
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </>
              )}

              {activeView === 'friends' && (
                <div className="card">
                  <div className="card-header">חברים</div>
                  <div className="card-body">
                    {friendRequests.filter(r => r.recipient_phone === user.phone).map(request => {
                      const requester = users.find(u => u.phone === request.requester_phone);
                      return (
                        <div key={request.id} className="friend-card">
                          <div className="avatar">{getInitials(requester?.name || request.requester_phone)}</div>
                          <div className="friend-info">
                            <div className="friend-name">{requester?.name || request.requester_phone}</div>
                            <div style={{fontSize: '0.85rem', color: '#65676b'}}>רוצה להתחבר אליך</div>
                          </div>
                          <button onClick={() => acceptFriendRequest(request)} className="btn btn-primary btn-small">
                            אשר
                          </button>
                        </div>
                      );
                    })}
                    {friends.map(friendship => {
                      const friendPhone = friendship.user1_phone === user.phone ? friendship.user2_phone : friendship.user1_phone;
                      const friendUser = users.find(u => u.phone === friendPhone);
                      return (
                        <div key={friendship.id} className="friend-card" onClick={() => setSelectedProfile(friendUser)}>
                          <div className="avatar">{getInitials(friendUser?.name || friendPhone)}</div>
                          <div className="friend-info">
                            <div className="friend-name">{friendUser?.name || friendPhone}</div>
                          </div>
                        </div>
                      );
                    })}
                    {friendRequests.filter(r => r.recipient_phone === user.phone).length === 0 && friends.length === 0 && (
                      <div className="empty-state">
                        <i className="fas fa-user-friends"></i>
                        <div>עדיין אין לך חברים</div>
                        <div style={{fontSize: '0.9rem', marginTop: '0.5rem'}}>חפש חברים ושלח להם בקשת חברות!</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeView === 'groups' && !selectedGroup && (
                <>
                  <div className="card">
                    <div className="card-header" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <span>הקבוצות שלי</span>
                      <button onClick={() => setShowCreateGroup(true)} className="btn btn-primary btn-small">
                        <i className="fas fa-plus"></i> צור קבוצה
                      </button>
                    </div>
                    <div className="card-body">
                      {myGroups.map(member => (
                        <div key={member.id} className="group-card" onClick={() => setSelectedGroup(member.groups)}>
                          <div className="group-icon">{getInitials(member.groups.name)}</div>
                          <div className="group-info">
                            <div className="group-name">
                              {member.groups.name}
                              {member.role === 'admin' && <span className="badge badge-admin" style={{marginRight: '0.5rem'}}>מנהל</span>}
                            </div>
                            <div className="group-meta">
                              {member.groups.type === 'group' ? 'קבוצה' : 'דף'} • {member.groups.privacy === 'public' ? 'ציבורי' : 'פרטי'}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="card">
                    <div className="card-header">גלה קבוצות</div>
                    <div className="card-body">
                      {groups.filter(g => !isGroupMember(g.id)).map(group => (
                        <div key={group.id} className="group-card">
                          <div className="group-icon">{getInitials(group.name)}</div>
                          <div className="group-info">
                            <div className="group-name">{group.name}</div>
                            <div className="group-meta">
                              {group.type === 'group' ? 'קבוצה' : 'דף'} • {group.privacy === 'public' ? 'ציבורי' : 'פרטי'}
                            </div>
                          </div>
                          <button onClick={() => joinGroup(group.id)} className="btn btn-primary btn-small">
                            {group.privacy === 'private' ? 'בקש הצטרפות' : 'הצטרף'}
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                </>
              )}

              {activeView === 'search' && !selectedProfile && !selectedGroup && (
                <div className="card">
                  <div className="card-header">
                    תוצאות חיפוש עבור "{searchTerm}"
                    {filteredUsers.length === 0 && <span style={{color: '#65676b', fontWeight: 'normal', marginRight: '0.5rem'}}>- לא נמצאו תוצאות</span>}
                  </div>
                  <div className="card-body">
                    {filteredUsers.length > 0 ? (
                      filteredUsers.map(otherUser => (
                        <div key={otherUser.phone} className="friend-card">
                          <div className="avatar" onClick={() => setSelectedProfile(otherUser)}>
                            {getInitials(otherUser.name)}
                          </div>
                          <div className="friend-info">
                            <div className="friend-name" onClick={() => setSelectedProfile(otherUser)}>{otherUser.name}</div>
                            {otherUser.bio && <div style={{fontSize: '0.85rem', color: '#65676b'}}>{otherUser.bio}</div>}
                          </div>
                          {isFriend(otherUser.phone) ? (
                            <div style={{fontSize: '0.9rem', color: '#10b981', fontWeight: 600}}>
                              <i className="fas fa-check-circle"></i> חברים
                            </div>
                          ) : hasPendingRequest(otherUser.phone) ? (
                            <div style={{fontSize: '0.9rem', color: '#6b7280', fontWeight: 600}}>
                              ממתין...
                            </div>
                          ) : (
                            <button onClick={() => sendFriendRequest(otherUser.phone)} className="btn btn-primary btn-small">
                              <i className="fas fa-user-plus"></i> הוסף חבר
                            </button>
                          )}
                        </div>
                      ))
                    ) : (
                      <div className="empty-state">
                        <i className="fas fa-search"></i>
                        <div>לא נמצאו משתמשים התואמים לחיפוש</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeView === 'hevre-ai' && !selectedProfile && !selectedGroup && (
                <div className="card">
                  <div className="card-header" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '0.5rem'}}>
                    <span><i className="fas fa-robot"></i> החבר'ה AI</span>
                    <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                      <span style={{fontSize: '0.9rem', color: '#65676b'}}>
                        קרדיטים: <strong style={{color: userCredits > 0 ? '#10b981' : '#ef4444'}}>{userCredits}</strong>
                      </span>
                      <button
                        onClick={async () => {
                          if (bankBalance >= 3) {
                            const confirm = window.confirm('לקנות 10 קרדיטים ב-$3?');
                            if (confirm) {
                              try {
                                await supabase.from('user_credits').update({ credits: userCredits + 10 }).eq('user_phone', user.phone);
                                await supabase.from('user_bank_accounts').update({ balance: bankBalance - 3 }).eq('user_phone', user.phone);
                                setUserCredits(userCredits + 10);
                                setBankBalance(bankBalance - 3);
                                alert('נרכשו 10 קרדיטים בהצלחה! 🎉');
                              } catch (err) {
                                alert('שגיאה: ' + err.message);
                              }
                            }
                          } else {
                            alert('אין לך מספיק כסף בחשבון הבנק. עבור לשוק ההון כדי להרוויח עוד כסף!');
                          }
                        }}
                        className="btn btn-primary btn-small"
                        style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', border: 'none'}}
                      >
                        <i className="fas fa-shopping-cart"></i> קנה 10 קרדיטים ($3)
                      </button>
                      <button onClick={() => { setAdminPassword(''); setShowAdminPanel(false); if (window.prompt('הכנס סיסמת אדמין:') === '316439249') { setShowAdminPanel(true); loadAIRequests(); } }} className="btn btn-secondary btn-small">
                        <i className="fas fa-user-shield"></i> אדמין
                      </button>
                    </div>
                  </div>
                  <div className="card-body">
                    {!showAdminPanel ? (
                      <>
                        <div style={{marginBottom: '1.5rem', padding: '1rem', background: '#f0f9ff', borderRadius: '8px', border: '1px solid #bfdbfe'}}>
                          <p style={{fontSize: '0.95rem', color: '#1e40af', marginBottom: '0.5rem'}}>
                            <strong>ברוכים הבאים למחולל הקול של החבר'ה!</strong>
                          </p>
                          <p style={{fontSize: '0.85rem', color: '#3b82f6'}}>
                            בחר דמות מהחבר'ה, כתוב מה תרצה שהיא תגיד, והקלטה תגיע לך בוואטסאפ בקרוב
                          </p>
                        </div>

                        <div style={{display: 'grid', gridTemplateColumns: '1fr', gap: '1rem', marginBottom: '1.5rem', padding: '1.5rem', background: 'white', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.08)'}}>
                          <div>
                            <label style={{display: 'block', marginBottom: '0.75rem', fontWeight: '600', color: '#1f2937', fontSize: '1rem'}}>
                              <i className="fas fa-user-circle" style={{marginLeft: '0.5rem', color: '#3b82f6'}}></i>
                              בחר דמות
                            </label>
                            <select
                              value={selectedCharacter?.id || ''}
                              onChange={(e) => {
                                const char = aiCharacters.find(c => c.id === e.target.value);
                                setSelectedCharacter(char);
                              }}
                              style={{
                                width: '100%',
                                padding: '0.875rem',
                                border: '2px solid #e5e7eb',
                                borderRadius: '8px',
                                fontSize: '1rem',
                                background: 'white',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                outline: 'none'
                              }}
                              onFocus={(e) => e.target.style.borderColor = '#3b82f6'}
                              onBlur={(e) => e.target.style.borderColor = '#e5e7eb'}
                            >
                              <option value="">-- בחר דמות מהרשימה --</option>
                              {aiCharacters.map(char => (
                                <option key={char.id} value={char.id}>
                                  {char.flag} {char.name} - {char.role} ({char.location})
                                </option>
                              ))}
                            </select>
                          </div>

                          {selectedCharacter && (
                            <div style={{padding: '1rem', background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)', borderRadius: '8px', border: '2px solid #3b82f6'}}>
                              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.5rem'}}>
                                <span style={{fontSize: '2rem'}}>{selectedCharacter.flag}</span>
                                <div>
                                  <div style={{fontWeight: '700', fontSize: '1.1rem', color: '#1e40af'}}>{selectedCharacter.name}</div>
                                  <div style={{fontSize: '0.85rem', color: '#3b82f6'}}>
                                    {selectedCharacter.role} • {selectedCharacter.location}
                                  </div>
                                </div>
                              </div>
                              <div style={{fontSize: '0.8rem', color: '#6b7280', marginTop: '0.5rem'}}>
                                <i className="fas fa-birthday-cake" style={{marginLeft: '0.25rem'}}></i>
                                {selectedCharacter.birth_date}
                              </div>
                            </div>
                          )}

                          <div>
                            <label style={{display: 'block', marginBottom: '0.75rem', fontWeight: '600', color: '#1f2937', fontSize: '1rem'}}>
                              <i className="fas fa-comment-dots" style={{marginLeft: '0.5rem', color: '#3b82f6'}}></i>
                              מה הדמות תגיד?
                            </label>
                          <textarea
                            value={aiPrompt}
                            onChange={(e) => setAiPrompt(e.target.value)}
                            placeholder="לדוגמה: תגיד שלום לכולם ותברך אותם ביום הולדת..."
                            style={{
                              width: '100%',
                              minHeight: '120px',
                              padding: '0.875rem',
                              border: '2px solid #e5e7eb',
                              borderRadius: '8px',
                              fontSize: '0.95rem',
                              resize: 'vertical',
                              transition: 'all 0.2s',
                              outline: 'none'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#3b82f6'}
                            onBlur={(e) => e.target.style.borderColor = '#e5e7eb'}
                          />
                          </div>

                          <button
                            onClick={handleGenerateAI}
                            disabled={!selectedCharacter || !aiPrompt.trim() || userCredits < 1}
                            className="btn btn-primary"
                            style={{
                              width: '100%',
                              padding: '1rem',
                              fontSize: '1.1rem',
                              fontWeight: '700',
                              background: (!selectedCharacter || !aiPrompt.trim() || userCredits < 1) ? '#9ca3af' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: (!selectedCharacter || !aiPrompt.trim() || userCredits < 1) ? 'not-allowed' : 'pointer',
                              transition: 'all 0.2s',
                              boxShadow: '0 4px 12px rgba(59, 130, 246, 0.3)'
                            }}
                          >
                            <i className="fas fa-magic"></i> Generate ({userCredits} קרדיטים נותרו)
                          </button>
                        </div>

                        {userCredits < 1 && (
                          <div style={{marginTop: '1rem', padding: '1rem', background: '#fef2f2', border: '1px solid #fecaca', borderRadius: '8px', textAlign: 'center'}}>
                            <div style={{color: '#dc2626', fontWeight: '600', marginBottom: '0.5rem'}}>
                              <i className="fas fa-exclamation-triangle"></i> אין לך מספיק קרדיטים
                            </div>
                            <div style={{fontSize: '0.85rem', color: '#6b7280', marginBottom: '0.75rem'}}>
                              רכוש 10 קרדיטים ב-$3 בלבד!
                            </div>
                            <button
                              onClick={async () => {
                                if (bankBalance >= 3) {
                                  const confirm = window.confirm('לקנות 10 קרדיטים ב-$3?');
                                  if (confirm) {
                                    try {
                                      await supabase.from('user_credits').update({ credits: userCredits + 10 }).eq('user_phone', user.phone);
                                      await supabase.from('user_bank_accounts').update({ balance: bankBalance - 3 }).eq('user_phone', user.phone);
                                      setUserCredits(userCredits + 10);
                                      setBankBalance(bankBalance - 3);
                                      alert('נרכשו 10 קרדיטים בהצלחה! 🎉');
                                    } catch (err) {
                                      alert('שגיאה: ' + err.message);
                                    }
                                  }
                                } else {
                                  alert('אין לך מספיק כסף בחשבון הבנק ($' + bankBalance.toFixed(2) + '). עבור לשוק ההון כדי להרוויח עוד כסף!');
                                }
                              }}
                              className="btn btn-primary btn-small"
                              style={{background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', border: 'none'}}
                            >
                              <i className="fas fa-shopping-cart"></i> קנה עכשיו
                            </button>
                          </div>
                        )}
                      </>
                    ) : (
                      <>
                        <div style={{marginBottom: '1.5rem', padding: '1rem', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fbbf24'}}>
                          <strong>פאנל אדמין</strong> - רשימת כל בקשות ה-AI
                        </div>
                        {aiRequests.length === 0 ? (
                          <div className="empty-state">
                            <i className="fas fa-inbox"></i>
                            <div>אין בקשות</div>
                          </div>
                        ) : (
                          <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                            {aiRequests.map(req => (
                              <div key={req.id} style={{padding: '1rem', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem'}}>
                                  <strong style={{color: '#1f2937'}}>{req.user_phone}</strong>
                                  <span style={{fontSize: '0.85rem', color: '#6b7280'}}>
                                    {new Date(req.created_at).toLocaleString('he-IL')}
                                  </span>
                                </div>
                                <div style={{marginBottom: '0.5rem'}}>
                                  <span style={{fontSize: '0.9rem', color: '#3b82f6', fontWeight: '600'}}>
                                    דמות: {req.character_name}
                                  </span>
                                </div>
                                <div style={{padding: '0.75rem', background: 'white', borderRadius: '6px', fontSize: '0.9rem', color: '#374151'}}>
                                  {req.prompt}
                                </div>
                                <div style={{marginTop: '0.5rem', fontSize: '0.85rem'}}>
                                  <span style={{
                                    padding: '0.25rem 0.5rem',
                                    background: req.status === 'pending' ? '#fef3c7' : '#d1fae5',
                                    color: req.status === 'pending' ? '#d97706' : '#059669',
                                    borderRadius: '4px',
                                    fontWeight: '600'
                                  }}>
                                    {req.status === 'pending' ? 'ממתין' : 'הושלם'}
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </>
                    )}
                  </div>
                </div>
              )}

              {activeView === 'stocks' && !selectedProfile && !selectedGroup && (
                <>
                  <div className="card" style={{marginBottom: '1.5rem'}}>
                    <div className="card-header">
                      <i className="fas fa-wallet"></i> חשבון הבנק שלי
                    </div>
                    <div className="card-body" style={{textAlign: 'center'}}>
                      <div style={{fontSize: '2.5rem', fontWeight: '700', color: '#10b981', marginBottom: '0.5rem'}}>
                        ${bankBalance.toFixed(2)}
                      </div>
                      <div style={{fontSize: '0.9rem', color: '#6b7280', marginBottom: '1rem'}}>יתרה זמינה</div>
                      <div style={{padding: '0.75rem', background: '#f0f9ff', borderRadius: '6px', border: '1px solid #bfdbfe'}}>
                        <div style={{fontSize: '0.85rem', color: '#3b82f6', marginBottom: '0.5rem'}}>
                          <i className="fas fa-info-circle"></i> <strong>רוצה קרדיטים AI?</strong>
                        </div>
                        <div style={{fontSize: '0.8rem', color: '#6b7280'}}>
                          10 קרדיטים = $3 | עבור ל-"החבר'ה AI" כדי לקנות
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="card" style={{marginBottom: '1.5rem'}}>
                    <div className="card-header">
                      <i className="fas fa-briefcase"></i> התיק שלי
                    </div>
                    <div className="card-body">
                      {userPortfolio.length === 0 ? (
                        <div className="empty-state">
                          <i className="fas fa-chart-pie"></i>
                          <div>אין לך מניות עדיין</div>
                          <div style={{fontSize: '0.9rem', marginTop: '0.5rem'}}>התחל להשקיע במניות של החבר'ה!</div>
                        </div>
                      ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                          {userPortfolio.map(pos => {
                            const stock = stockPrices.find(s => s.member_name === pos.member_name);
                            const currentValue = stock ? pos.shares * stock.current_price : 0;
                            const totalInvested = pos.shares * pos.average_buy_price;
                            const profitLoss = currentValue - totalInvested;
                            const profitLossPercent = ((profitLoss / totalInvested) * 100).toFixed(2);

                            return (
                              <div key={pos.id} style={{padding: '1rem', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.5rem'}}>
                                  <div>
                                    <div style={{fontWeight: '600', fontSize: '1rem', marginBottom: '0.25rem'}}>{pos.member_name}</div>
                                    <div style={{fontSize: '0.85rem', color: '#6b7280'}}>{pos.shares} מניות</div>
                                  </div>
                                  <div style={{textAlign: 'left'}}>
                                    <div style={{fontWeight: '600', fontSize: '1.1rem'}}>${currentValue.toFixed(2)}</div>
                                    <div style={{fontSize: '0.85rem', color: profitLoss >= 0 ? '#10b981' : '#ef4444', fontWeight: '600'}}>
                                      {profitLoss >= 0 ? '+' : ''}{profitLossPercent}%
                                    </div>
                                  </div>
                                </div>
                                <div style={{fontSize: '0.8rem', color: '#9ca3af'}}>
                                  מחיר ממוצע: ${pos.average_buy_price.toFixed(2)} | מחיר נוכחי: ${stock?.current_price.toFixed(2)}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="card">
                    <div className="card-header">
                      <i className="fas fa-chart-line"></i> שוק המניות
                    </div>
                    <div className="card-body">
                      <div style={{marginBottom: '1rem', padding: '0.75rem', background: '#f0f9ff', borderRadius: '8px', fontSize: '0.85rem', color: '#3b82f6', textAlign: 'center'}}>
                        <i className="fas fa-info-circle"></i> המחירים מתעדכנים כל 30 שניות בזמן אמת
                      </div>

                      <div style={{marginBottom: '1.5rem'}}>
                        {stockPrices.map(stock => {
                          const userPos = userPortfolio.find(p => p.member_name === stock.member_name);
                          const isSelected = selectedStock === stock.member_name;
                          const priceChangeColor = stock.daily_change_percent >= 0 ? '#10b981' : '#ef4444';
                          const priceChangeBg = stock.daily_change_percent >= 0 ? '#d1fae5' : '#fee2e2';

                          return (
                            <div
                              key={stock.member_name}
                              style={{
                                padding: '1rem',
                                marginBottom: '0.75rem',
                                background: isSelected ? 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)' : 'white',
                                border: isSelected ? '2px solid #3b82f6' : '1px solid #e5e7eb',
                                borderRadius: '12px',
                                transition: 'all 0.2s',
                                boxShadow: isSelected ? '0 4px 12px rgba(59, 130, 246, 0.2)' : '0 1px 3px rgba(0,0,0,0.05)'
                              }}
                            >
                              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.75rem'}}>
                                <div style={{flex: 1}}>
                                  <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem'}}>
                                    <span style={{fontWeight: '700', fontSize: '1.05rem', color: '#1f2937'}}>
                                      {stock.member_name}
                                    </span>
                                    <span style={{
                                      fontSize: '0.75rem',
                                      fontWeight: '600',
                                      color: '#6b7280',
                                      background: '#f3f4f6',
                                      padding: '0.15rem 0.4rem',
                                      borderRadius: '4px'
                                    }}>
                                      {stock.ticker}
                                    </span>
                                  </div>
                                  {userPos && (
                                    <div style={{fontSize: '0.8rem', color: '#3b82f6', fontWeight: '600'}}>
                                      <i className="fas fa-briefcase" style={{marginLeft: '0.25rem'}}></i>
                                      {userPos.shares.toFixed(2)} מניות
                                    </div>
                                  )}
                                </div>
                                <div style={{textAlign: 'left'}}>
                                  <div style={{fontWeight: '800', fontSize: '1.3rem', marginBottom: '0.25rem', color: '#1f2937'}}>
                                    ${stock.current_price.toFixed(2)}
                                  </div>
                                  <div style={{
                                    fontSize: '0.85rem',
                                    fontWeight: '700',
                                    color: priceChangeColor,
                                    background: priceChangeBg,
                                    padding: '0.2rem 0.5rem',
                                    borderRadius: '6px',
                                    display: 'inline-block'
                                  }}>
                                    {stock.daily_change_percent >= 0 ? '▲' : '▼'} {Math.abs(stock.daily_change_percent).toFixed(2)}%
                                  </div>
                                </div>
                              </div>

                              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '0.5rem'}}>
                                <button
                                  onClick={async (e) => {
                                    e.stopPropagation();
                                    const amount = parseFloat(window.prompt('כמה מניות לקנות?', '1'));
                                    if (!amount || amount <= 0) return;

                                    const totalCost = amount * stock.current_price;
                                    if (totalCost > bankBalance) {
                                      alert('אין לך מספיק כסף');
                                      return;
                                    }

                                    try {
                                      const existingPos = userPortfolio.find(p => p.member_name === stock.member_name);
                                      if (existingPos) {
                                        const newShares = existingPos.shares + amount;
                                        const newAvg = ((existingPos.shares * existingPos.average_buy_price) + (amount * stock.current_price)) / newShares;
                                        await supabase.from('user_stock_portfolios')
                                          .update({ shares: newShares, average_buy_price: newAvg, updated_at: new Date().toISOString() })
                                          .eq('id', existingPos.id);
                                      } else {
                                        await supabase.from('user_stock_portfolios').insert([{
                                          user_phone: user.phone,
                                          member_name: stock.member_name,
                                          shares: amount,
                                          average_buy_price: stock.current_price
                                        }]);
                                      }

                                      await supabase.from('stock_transactions').insert([{
                                        user_phone: user.phone,
                                        member_name: stock.member_name,
                                        transaction_type: 'buy',
                                        shares: amount,
                                        price_per_share: stock.current_price,
                                        total_amount: totalCost
                                      }]);

                                      await supabase.from('user_bank_accounts')
                                        .update({ balance: bankBalance - totalCost, updated_at: new Date().toISOString() })
                                        .eq('user_phone', user.phone);

                                      setBankBalance(bankBalance - totalCost);
                                      loadUserPortfolio();
                                      alert('קנייה בוצעה בהצלחה!');
                                    } catch (err) {
                                      alert('שגיאה בקנייה: ' + err.message);
                                    }
                                  }}
                                  style={{
                                    padding: '0.6rem',
                                    background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    fontSize: '0.85rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 2px 4px rgba(16, 185, 129, 0.3)'
                                  }}
                                  onMouseEnter={(e) => e.target.style.transform = 'translateY(-1px)'}
                                  onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                                >
                                  <i className="fas fa-arrow-up"></i> קנה
                                </button>
                                <button
                                  onClick={async (e) => {
                                    e.stopPropagation();
                                    const userPos = userPortfolio.find(p => p.member_name === stock.member_name);
                                    if (!userPos || userPos.shares <= 0) {
                                      alert('אין לך מניות למכור');
                                      return;
                                    }

                                    const amount = parseFloat(window.prompt(`יש לך ${userPos.shares.toFixed(2)} מניות. כמה למכור?`, '1'));
                                    if (!amount || amount <= 0 || amount > userPos.shares) {
                                      alert('כמות לא תקינה');
                                      return;
                                    }

                                    try {
                                      const totalRevenue = amount * stock.current_price;
                                      const newShares = userPos.shares - amount;

                                      if (newShares > 0) {
                                        await supabase.from('user_stock_portfolios')
                                          .update({ shares: newShares, updated_at: new Date().toISOString() })
                                          .eq('id', userPos.id);
                                      } else {
                                        await supabase.from('user_stock_portfolios').delete().eq('id', userPos.id);
                                      }

                                      await supabase.from('stock_transactions').insert([{
                                        user_phone: user.phone,
                                        member_name: stock.member_name,
                                        transaction_type: 'sell',
                                        shares: amount,
                                        price_per_share: stock.current_price,
                                        total_amount: totalRevenue
                                      }]);

                                      await supabase.from('user_bank_accounts')
                                        .update({ balance: bankBalance + totalRevenue, updated_at: new Date().toISOString() })
                                        .eq('user_phone', user.phone);

                                      setBankBalance(bankBalance + totalRevenue);
                                      loadUserPortfolio();
                                      alert('מכירה בוצעה בהצלחה!');
                                    } catch (err) {
                                      alert('שגיאה במכירה: ' + err.message);
                                    }
                                  }}
                                  style={{
                                    padding: '0.6rem',
                                    background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    fontSize: '0.85rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 2px 4px rgba(239, 68, 68, 0.3)'
                                  }}
                                  onMouseEnter={(e) => e.target.style.transform = 'translateY(-1px)'}
                                  onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                                >
                                  <i className="fas fa-arrow-down"></i> מכור
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setSelectedStock(stock.member_name);
                                    loadStockHistory(stock.member_name);
                                  }}
                                  style={{
                                    padding: '0.6rem',
                                    background: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    fontSize: '0.85rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: '0 2px 4px rgba(59, 130, 246, 0.3)'
                                  }}
                                  onMouseEnter={(e) => e.target.style.transform = 'translateY(-1px)'}
                                  onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                                >
                                  <i className="fas fa-chart-line"></i> פרטים
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {selectedStock && (
                        <div style={{padding: '2rem', background: 'linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)', borderRadius: '16px', border: '2px solid #3b82f6', boxShadow: '0 8px 24px rgba(59, 130, 246, 0.15)'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
                            <h4 style={{fontWeight: '700', fontSize: '1.3rem', color: '#1f2937', margin: 0}}>
                              <i className="fas fa-chart-area" style={{marginLeft: '0.5rem', color: '#3b82f6'}}></i>
                              {selectedStock}
                            </h4>
                            <button
                              onClick={() => setSelectedStock(null)}
                              style={{
                                padding: '0.5rem 1rem',
                                background: '#ef4444',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '0.9rem',
                                fontWeight: '600',
                                transition: 'all 0.2s'
                              }}
                              onMouseEnter={(e) => e.target.style.background = '#dc2626'}
                              onMouseLeave={(e) => e.target.style.background = '#ef4444'}
                            >
                              <i className="fas fa-times"></i> סגור
                            </button>
                          </div>

                          <div style={{padding: '1.5rem', background: 'white', borderRadius: '12px', marginBottom: '1.5rem', border: '1px solid #e5e7eb'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                              <div>
                                <div style={{fontSize: '0.8rem', color: '#6b7280', marginBottom: '0.25rem'}}>
                                  {stockPrices.find(s => s.member_name === selectedStock)?.ticker}
                                </div>
                                <div style={{fontWeight: '800', fontSize: '2rem', color: '#1f2937'}}>
                                  ${stockPrices.find(s => s.member_name === selectedStock)?.current_price.toFixed(2)}
                                </div>
                              </div>
                              <div style={{textAlign: 'left'}}>
                                <div style={{
                                  fontSize: '1.2rem',
                                  fontWeight: '700',
                                  color: stockPrices.find(s => s.member_name === selectedStock)?.daily_change_percent >= 0 ? '#10b981' : '#ef4444',
                                  background: stockPrices.find(s => s.member_name === selectedStock)?.daily_change_percent >= 0 ? '#d1fae5' : '#fee2e2',
                                  padding: '0.5rem 1rem',
                                  borderRadius: '8px'
                                }}>
                                  {stockPrices.find(s => s.member_name === selectedStock)?.daily_change_percent >= 0 ? '▲' : '▼'} {Math.abs(stockPrices.find(s => s.member_name === selectedStock)?.daily_change_percent || 0).toFixed(2)}%
                                </div>
                              </div>
                            </div>

                            {stockPriceHistory[selectedStock] && stockPriceHistory[selectedStock].length > 5 ? (
                              <div style={{marginTop: '1.5rem'}}>
                                <canvas
                                  ref={(canvas) => {
                                    if (canvas && stockPriceHistory[selectedStock]) {
                                      const ctx = canvas.getContext('2d');
                                      if (window.stockChart) window.stockChart.destroy();

                                      const history = stockPriceHistory[selectedStock];
                                      const prices = history.map(h => parseFloat(h.price));
                                      const labels = history.map((h, i) => i === 0 ? 'התחלה' : i === history.length - 1 ? 'עכשיו' : '');

                                      const isPositive = prices[prices.length - 1] >= prices[0];

                                      window.stockChart = new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                          labels: labels,
                                          datasets: [{
                                            label: 'מחיר',
                                            data: prices,
                                            borderColor: isPositive ? '#10b981' : '#ef4444',
                                            backgroundColor: isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4,
                                            pointRadius: 0,
                                            pointHoverRadius: 6,
                                            pointHoverBackgroundColor: isPositive ? '#10b981' : '#ef4444',
                                            pointHoverBorderColor: '#fff',
                                            pointHoverBorderWidth: 2
                                          }]
                                        },
                                        options: {
                                          responsive: true,
                                          maintainAspectRatio: true,
                                          aspectRatio: 2,
                                          interaction: {
                                            intersect: false,
                                            mode: 'index'
                                          },
                                          plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                              backgroundColor: '#1f2937',
                                              padding: 12,
                                              bodyFont: { size: 14, weight: 'bold' },
                                              displayColors: false,
                                              callbacks: {
                                                label: (context) => '$' + context.parsed.y.toFixed(2)
                                              }
                                            }
                                          },
                                          scales: {
                                            y: {
                                              ticks: {
                                                callback: (value) => '$' + value.toFixed(2),
                                                font: { size: 11, weight: '600' },
                                                color: '#6b7280'
                                              },
                                              grid: {
                                                color: '#f3f4f6',
                                                drawBorder: false
                                              }
                                            },
                                            x: {
                                              ticks: {
                                                font: { size: 11, weight: '600' },
                                                color: '#6b7280'
                                              },
                                              grid: { display: false, drawBorder: false }
                                            }
                                          }
                                        }
                                      });
                                    }
                                  }}
                                  style={{maxHeight: '250px'}}
                                />
                              </div>
                            ) : (
                              <div style={{padding: '2rem', textAlign: 'center', color: '#6b7280', fontSize: '0.9rem'}}>
                                <i className="fas fa-chart-line" style={{fontSize: '2rem', marginBottom: '0.5rem', opacity: 0.3}}></i>
                                <div>אוסף נתוני גרף...</div>
                                <div style={{fontSize: '0.8rem', marginTop: '0.25rem'}}>הגרף יופיע לאחר מספר עדכוני מחירים</div>
                              </div>
                            )}
                          </div>

                          <div style={{marginBottom: '1.5rem'}}>
                            <label style={{display: 'block', marginBottom: '0.75rem', fontWeight: '700', color: '#1f2937', fontSize: '1rem'}}>
                              <i className="fas fa-hashtag" style={{marginLeft: '0.25rem', color: '#3b82f6'}}></i>
                              כמות מניות
                            </label>
                            <input
                              type="number"
                              min="0.01"
                              step="0.01"
                              value={stockAmount}
                              onChange={(e) => setStockAmount(e.target.value)}
                              placeholder="0.00"
                              style={{
                                width: '100%',
                                padding: '1rem',
                                border: '2px solid #e5e7eb',
                                borderRadius: '10px',
                                fontSize: '1.1rem',
                                fontWeight: '600',
                                outline: 'none',
                                transition: 'all 0.2s'
                              }}
                              onFocus={(e) => e.target.style.borderColor = '#3b82f6'}
                              onBlur={(e) => e.target.style.borderColor = '#e5e7eb'}
                            />
                          </div>

                          {stockAmount && (
                            <div style={{marginBottom: '1.5rem', padding: '1rem', background: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)', borderRadius: '10px', border: '2px solid #3b82f6'}}>
                              <div style={{fontSize: '0.85rem', color: '#1e40af', marginBottom: '0.25rem', fontWeight: '600'}}>
                                סכום כולל:
                              </div>
                              <div style={{fontSize: '1.8rem', fontWeight: '800', color: '#1e40af'}}>
                                ${(parseFloat(stockAmount) * stockPrices.find(s => s.member_name === selectedStock)?.current_price || 0).toFixed(2)}
                              </div>
                            </div>
                          )}

                          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '0.75rem'}}>
                            <button
                              onClick={buyStock}
                              style={{
                                padding: '1rem',
                                background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                fontSize: '0.95rem',
                                fontWeight: '700',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)'
                              }}
                              onMouseEnter={(e) => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 6px 16px rgba(16, 185, 129, 0.4)'; }}
                              onMouseLeave={(e) => { e.target.style.transform = 'translateY(0)'; e.target.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)'; }}
                            >
                              <i className="fas fa-arrow-up"></i><br/>קנה
                            </button>
                            <button
                              onClick={sellStock}
                              style={{
                                padding: '1rem',
                                background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                fontSize: '0.95rem',
                                fontWeight: '700',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)'
                              }}
                              onMouseEnter={(e) => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 6px 16px rgba(239, 68, 68, 0.4)'; }}
                              onMouseLeave={(e) => { e.target.style.transform = 'translateY(0)'; e.target.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.3)'; }}
                            >
                              <i className="fas fa-arrow-down"></i><br/>מכור
                            </button>
                            <button
                              onClick={shortStock}
                              style={{
                                padding: '1rem',
                                background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                fontSize: '0.95rem',
                                fontWeight: '700',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                boxShadow: '0 4px 12px rgba(245, 158, 11, 0.3)'
                              }}
                              onMouseEnter={(e) => { e.target.style.transform = 'translateY(-2px)'; e.target.style.boxShadow = '0 6px 16px rgba(245, 158, 11, 0.4)'; }}
                              onMouseLeave={(e) => { e.target.style.transform = 'translateY(0)'; e.target.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.3)'; }}
                            >
                              <i className="fas fa-chart-line"></i><br/>שורט
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </>
              )}

              {selectedProfile && (
                <ProfileView
                  profile={selectedProfile}
                  isOwnProfile={selectedProfile.phone === user.phone}
                  onClose={() => setSelectedProfile(null)}
                  onEditProfile={() => setShowEditProfile(true)}
                  isFriend={isFriend(selectedProfile.phone)}
                  hasPendingRequest={hasPendingRequest(selectedProfile.phone)}
                  onSendFriendRequest={() => sendFriendRequest(selectedProfile.phone)}
                  getInitials={getInitials}
                  user={user}
                  userProfile={userProfile}
                />
              )}

              {selectedGroup && (
                <GroupView
                  group={selectedGroup}
                  onClose={() => setSelectedGroup(null)}
                  user={user}
                  userProfile={userProfile}
                  myGroups={myGroups}
                  getInitials={getInitials}
                  formatTime={formatTime}
                />
              )}
            </div>

            <div className="sidebar">
              <div className="card">
                <div className="card-header">אנשים שאולי תכיר</div>
                <div className="card-body">
                  {filteredUsers.slice(0, 5).map(otherUser => (
                    <div key={otherUser.phone} className="friend-card" onClick={() => setSelectedProfile(otherUser)}>
                      <div className="avatar" style={{width: '36px', height: '36px', fontSize: '0.9rem'}}>
                        {getInitials(otherUser.name)}
                      </div>
                      <div className="friend-info">
                        <div className="friend-name">{otherUser.name}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {showCreatePost && (
            <div className="modal" onClick={() => setShowCreatePost(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <div className="modal-title">צור פוסט</div>
                  <button className="modal-close" onClick={() => setShowCreatePost(false)}>
                    <i className="fas fa-times"></i>
                  </button>
                </div>
                <div className="modal-body">
                  <div className="post-header">
                    <div className="avatar">{getInitials(userProfile.name)}</div>
                    <div className="post-author">
                      <div className="post-author-name">{userProfile.name}</div>
                    </div>
                  </div>
                  <textarea
                    className="post-content-input"
                    placeholder="מה עובר עליך?"
                    value={newPost}
                    onChange={(e) => setNewPost(e.target.value)}
                    autoFocus
                  />
                  <div style={{marginTop: '1rem'}}>
                    <button onClick={createPost} className="btn btn-primary" style={{width: '100%'}}>
                      פרסם
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {showEditProfile && (
            <EditProfileModal
              profile={userProfile}
              onClose={() => setShowEditProfile(false)}
              onSave={updateProfile}
            />
          )}

          {showCreateGroup && (
            <CreateGroupModal
              onClose={() => setShowCreateGroup(false)}
              onCreate={createGroup}
            />
          )}
        </div>
      );
    };

    const ProfileView = ({ profile, isOwnProfile, onClose, onEditProfile, isFriend, hasPendingRequest, onSendFriendRequest, getInitials, user, userProfile }) => {
      const [wallPosts, setWallPosts] = React.useState([]);
      const [newWallPost, setNewWallPost] = React.useState('');
      const [activeTab, setActiveTab] = React.useState('timeline');

      React.useEffect(() => {
        loadWallPosts();
      }, [profile]);

      const loadWallPosts = async () => {
        const { data } = await supabase
          .from('wall_posts')
          .select('*')
          .eq('wall_owner_phone', profile.phone)
          .order('created_at', { ascending: false });
        if (data) setWallPosts(data);
      };

      const postToWall = async () => {
        if (!newWallPost.trim()) return;
        await supabase.from('wall_posts').insert([{
          wall_owner_phone: profile.phone,
          author_phone: user.phone,
          author_name: userProfile.name,
          content: newWallPost
        }]);
        setNewWallPost('');
        loadWallPosts();
      };

      return (
        <div>
          <div className="profile-header">
            <div className="cover-photo">
              {getInitials(profile.name)}
            </div>
            <div className="profile-info">
              <div className="profile-avatar">{getInitials(profile.name)}</div>
              <div className="profile-details">
                <div className="profile-name">{profile.name}</div>
                {profile.bio && <div className="profile-bio">{profile.bio}</div>}
                {isOwnProfile && (
                  <button onClick={onEditProfile} className="btn btn-secondary btn-small">
                    <i className="fas fa-edit"></i> ערוך פרופיל
                  </button>
                )}
                {!isOwnProfile && !isFriend && !hasPendingRequest && (
                  <button onClick={onSendFriendRequest} className="btn btn-primary btn-small">
                    <i className="fas fa-user-plus"></i> הוסף חבר
                  </button>
                )}
                {!isOwnProfile && hasPendingRequest && (
                  <button className="btn btn-secondary btn-small" disabled>
                    <i className="fas fa-clock"></i> ממתין...
                  </button>
                )}
              </div>
            </div>
            <div className="profile-tabs">
              <button className={`profile-tab ${activeTab === 'timeline' ? 'active' : ''}`} onClick={() => setActiveTab('timeline')}>
                ציר זמן
              </button>
              <button className={`profile-tab ${activeTab === 'about' ? 'active' : ''}`} onClick={() => setActiveTab('about')}>
                אודות
              </button>
            </div>
          </div>

          {activeTab === 'timeline' && (
            <>
              <div className="card">
                <div className="card-body">
                  <textarea
                    className="post-content-input"
                    placeholder={`כתוב משהו ל${profile.name.split(' ')[0]}...`}
                    value={newWallPost}
                    onChange={(e) => setNewWallPost(e.target.value)}
                  />
                  <button onClick={postToWall} className="btn btn-primary" style={{marginTop: '0.5rem'}}>
                    פרסם
                  </button>
                </div>
              </div>

              {wallPosts.map(post => (
                <div key={post.id} className="card">
                  <div className="post">
                    <div className="post-header">
                      <div className="avatar">{getInitials(post.author_name)}</div>
                      <div className="post-author">
                        <div className="post-author-name">{post.author_name}</div>
                        <div className="post-time">פרסם בקיר של {profile.name.split(' ')[0]}</div>
                      </div>
                    </div>
                    <div className="post-content">{post.content}</div>
                  </div>
                </div>
              ))}
            </>
          )}

          {activeTab === 'about' && (
            <div className="card">
              <div className="card-body">
                {profile.work && <div style={{marginBottom: '1rem'}}><strong>עבודה:</strong> {profile.work}</div>}
                {profile.education && <div style={{marginBottom: '1rem'}}><strong>השכלה:</strong> {profile.education}</div>}
                {profile.location && <div style={{marginBottom: '1rem'}}><strong>מיקום:</strong> {profile.location}</div>}
                {profile.relationship_status && <div style={{marginBottom: '1rem'}}><strong>סטטוס:</strong> {profile.relationship_status}</div>}
                {!profile.work && !profile.education && !profile.location && (
                  <div className="empty-state">
                    <i className="fas fa-info-circle"></i>
                    <div>אין מידע נוסף</div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    const GroupView = ({ group, onClose, user, userProfile, myGroups, getInitials, formatTime }) => {
      const [groupPosts, setGroupPosts] = React.useState([]);
      const [newPost, setNewPost] = React.useState('');
      const [members, setMembers] = React.useState([]);
      const [activeTab, setActiveTab] = React.useState('posts');

      const membership = myGroups.find(m => m.group_id === group.id);
      const isAdmin = membership?.role === 'admin';

      React.useEffect(() => {
        loadGroupPosts();
        loadMembers();
      }, [group]);

      const loadGroupPosts = async () => {
        const { data } = await supabase
          .from('group_posts')
          .select('*')
          .eq('group_id', group.id)
          .order('created_at', { ascending: false });
        if (data) setGroupPosts(data);
      };

      const loadMembers = async () => {
        const { data } = await supabase
          .from('group_members')
          .select('*, user_profiles(*)')
          .eq('group_id', group.id);
        if (data) setMembers(data);
      };

      const createGroupPost = async () => {
        if (!newPost.trim()) return;
        await supabase.from('group_posts').insert([{
          group_id: group.id,
          author_phone: user.phone,
          author_name: userProfile.name,
          content: newPost
        }]);
        setNewPost('');
        loadGroupPosts();
      };

      return (
        <div>
          <div className="profile-header">
            <div className="cover-photo">
              {getInitials(group.name)}
            </div>
            <div className="profile-info">
              <div className="profile-avatar">{getInitials(group.name)}</div>
              <div className="profile-details">
                <div className="profile-name">{group.name}</div>
                <div className="profile-bio">{group.description}</div>
                <div className="profile-stats">
                  <span>{members.length} חברים</span>
                  <span>•</span>
                  <span>{group.type === 'group' ? 'קבוצה' : 'דף'} {group.privacy === 'public' ? 'ציבורית' : 'פרטית'}</span>
                </div>
              </div>
            </div>
            <div className="profile-tabs">
              <button className={`profile-tab ${activeTab === 'posts' ? 'active' : ''}`} onClick={() => setActiveTab('posts')}>
                פוסטים
              </button>
              <button className={`profile-tab ${activeTab === 'members' ? 'active' : ''}`} onClick={() => setActiveTab('members')}>
                חברים
              </button>
            </div>
          </div>

          {activeTab === 'posts' && (
            <>
              <div className="card">
                <div className="card-body">
                  <textarea
                    className="post-content-input"
                    placeholder="כתוב משהו..."
                    value={newPost}
                    onChange={(e) => setNewPost(e.target.value)}
                  />
                  <button onClick={createGroupPost} className="btn btn-primary" style={{marginTop: '0.5rem'}}>
                    פרסם
                  </button>
                </div>
              </div>

              {groupPosts.map(post => (
                <div key={post.id} className="card">
                  <div className="post">
                    <div className="post-header">
                      <div className="avatar">{getInitials(post.author_name)}</div>
                      <div className="post-author">
                        <div className="post-author-name">{post.author_name}</div>
                        <div className="post-time">{formatTime(post.created_at)}</div>
                      </div>
                    </div>
                    <div className="post-content">{post.content}</div>
                  </div>
                </div>
              ))}
            </>
          )}

          {activeTab === 'members' && (
            <div className="card">
              <div className="card-header">{members.length} חברים</div>
              <div className="card-body">
                {members.map(member => (
                  <div key={member.id} className="friend-card">
                    <div className="avatar">{getInitials(member.user_profiles?.name || member.user_phone)}</div>
                    <div className="friend-info">
                      <div className="friend-name">{member.user_profiles?.name || member.user_phone}</div>
                      {member.role !== 'member' && (
                        <span className={`badge badge-${member.role}`}>{member.role === 'admin' ? 'מנהל' : 'מנהל משנה'}</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const EditProfileModal = ({ profile, onClose, onSave }) => {
      const [formData, setFormData] = React.useState({
        name: profile.name || '',
        bio: profile.bio || '',
        location: profile.location || '',
        work: profile.work || '',
        education: profile.education || '',
        relationship_status: profile.relationship_status || ''
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };

      return (
        <div className="modal" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">ערוך פרופיל</div>
              <button className="modal-close" onClick={onClose}>
                <i className="fas fa-times"></i>
              </button>
            </div>
            <div className="modal-body">
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label className="form-label">שם מלא</label>
                  <input
                    type="text"
                    className="form-input"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    placeholder="השם שלך"
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">ביוגרפיה</label>
                  <textarea
                    className="form-textarea"
                    value={formData.bio}
                    onChange={(e) => setFormData({...formData, bio: e.target.value})}
                    placeholder="ספר על עצמך..."
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">מיקום</label>
                  <input
                    type="text"
                    className="form-input"
                    value={formData.location}
                    onChange={(e) => setFormData({...formData, location: e.target.value})}
                    placeholder="איפה אתה גר?"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">עבודה</label>
                  <input
                    type="text"
                    className="form-input"
                    value={formData.work}
                    onChange={(e) => setFormData({...formData, work: e.target.value})}
                    placeholder="איפה אתה עובד?"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">השכלה</label>
                  <input
                    type="text"
                    className="form-input"
                    value={formData.education}
                    onChange={(e) => setFormData({...formData, education: e.target.value})}
                    placeholder="איפה למדת?"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">סטטוס מערכות יחסים</label>
                  <select
                    className="form-select"
                    value={formData.relationship_status}
                    onChange={(e) => setFormData({...formData, relationship_status: e.target.value})}
                  >
                    <option value="">בחר סטטוס</option>
                    <option value="רווק/ה">רווק/ה</option>
                    <option value="במערכת יחסים">במערכת יחסים</option>
                    <option value="מאורס/ת">מאורס/ת</option>
                    <option value="נשוי/אה">נשוי/אה</option>
                  </select>
                </div>
                <button type="submit" className="btn btn-primary" style={{width: '100%'}}>
                  שמור שינויים
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    };

    const CreateGroupModal = ({ onClose, onCreate }) => {
      const [formData, setFormData] = React.useState({
        name: '',
        description: '',
        type: 'group',
        privacy: 'public'
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (formData.name.trim() && formData.description.trim()) {
          onCreate(formData);
        }
      };

      return (
        <div className="modal" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">צור קבוצה / דף</div>
              <button className="modal-close" onClick={onClose}>
                <i className="fas fa-times"></i>
              </button>
            </div>
            <div className="modal-body">
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label className="form-label">שם</label>
                  <input
                    type="text"
                    className="form-input"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    placeholder="שם הקבוצה או הדף"
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">תיאור</label>
                  <textarea
                    className="form-textarea"
                    value={formData.description}
                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                    placeholder="תאר את הקבוצה או הדף"
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">סוג</label>
                  <select
                    className="form-select"
                    value={formData.type}
                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                  >
                    <option value="group">קבוצה</option>
                    <option value="page">דף</option>
                  </select>
                </div>
                <div className="form-group">
                  <label className="form-label">פרטיות</label>
                  <select
                    className="form-select"
                    value={formData.privacy}
                    onChange={(e) => setFormData({...formData, privacy: e.target.value})}
                  >
                    <option value="public">ציבורי</option>
                    <option value="private">פרטי</option>
                  </select>
                </div>
                <button type="submit" className="btn btn-primary" style={{width: '100%'}}>
                  צור
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MembersArea />);
  </script>
</body>
</html>
